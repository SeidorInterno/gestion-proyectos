generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum ProjectStatus {
  PLANIFICACION
  EN_PROGRESO
  PAUSADO
  COMPLETADO
  CANCELADO
}

enum ActivityStatus {
  PENDIENTE
  EN_PROGRESO
  COMPLETADO
  BLOQUEADO
}

enum ParticipationType {
  PREVIO_KICKOFF
  CLIENTE
  SEIDOR
  RECUPERADOS
  FIN_PROYECTO
}

enum RpaTool {
  UIPATH
  POWER_AUTOMATE
  POWER_APPS
  AUTOMATION_ANYWHERE
  BLUE_PRISM
  OTRO
}

enum PhaseType {
  PREPARE
  CONNECT
  REALIZE
  RUN
}

enum EventCategory {
  BLOCKER
  RISK
  PAUSE
  CHANGE
  ISSUE
  ABSENCE
  MILESTONE
}

enum EventStatus {
  ABIERTO
  EN_PROGRESO
  RESUELTO
  CERRADO
}

enum Priority {
  CRITICO
  ALTO
  MEDIO
  BAJO
}

enum ChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

// Support Pool Enums
enum SupportPoolStatus {
  ACTIVA
  PAUSADA
  CERRADA
  AGOTADA
}

enum TicketStage {
  BACKLOG
  EVALUACION
  EN_ESPERA
  ATENDIENDO
  ATENDIDO
  CANCELADO
}

enum TicketType {
  INCIDENCIA
  CAMBIO
  MEJORA
}

enum TicketPriority {
  ALTA
  MEDIA
  BAJA
}

// Models

// Tabla de Roles
model Role {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  hasLevels   Boolean  @default(false)
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("roles")
}

// Tabla de Niveles (para Consultores)
model ConsultorLevel {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("consultor_levels")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roleId           String
  role             Role            @relation(fields: [roleId], references: [id])
  consultorLevelId String?
  consultorLevel   ConsultorLevel? @relation(fields: [consultorLevelId], references: [id])

  projectsAsManager Project[]           @relation("ProjectManager")
  assignments       ProjectAssignment[]
  notifications     Notification[]
  eventsAssigned    ProjectEvent[]      @relation("EventAssignee")
  eventsReported    ProjectEvent[]      @relation("EventReporter")
  documentsUploaded ProjectDocument[]   @relation("DocumentUploader")
  timeEntries       TimeEntry[]

  // Soporte
  supportPoolAssignments SupportPoolAssignment[]
  ticketsAssigned        SupportTicket[]         @relation("TicketAssignee")
  ticketsCreated         SupportTicket[]         @relation("TicketCreator")
  ticketComments         TicketComment[]
  ticketAttachments      TicketAttachment[]
  ticketTimeEntries      TicketTimeEntry[]
  ticketHistory          TicketHistory[]

  @@map("users")
}

model Client {
  id        String   @id @default(cuid())
  name      String
  ruc       String?  @unique
  country   String?
  address   String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contacts     Contact[]
  projects     Project[]
  supportPools SupportPool[]

  @@map("clients")
}

model Contact {
  id        String   @id @default(cuid())
  name      String
  position  String?
  email     String?
  phone     String?
  isPrimary Boolean  @default(false)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  code        String?       @unique
  pep         String        @unique  // Código SAP/PEP para integración y billing
  status      ProjectStatus @default(PLANIFICACION)
  tool        RpaTool       @default(UIPATH)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?
  deletedBy   String?

  // Baseline (fechas originales planificadas)
  baselineStartDate  DateTime?
  baselineEndDate    DateTime?
  baselineTotalDays  Int?

  clientId    String
  client      Client        @relation(fields: [clientId], references: [id])
  managerId   String?
  manager     User?         @relation("ProjectManager", fields: [managerId], references: [id])

  phases         Phase[]
  assignments    ProjectAssignment[]
  events         ProjectEvent[]
  documents      ProjectDocument[]
  timeEntries    TimeEntry[]
  supportPools   SupportPool[]
  supportTickets SupportTicket[]

  @@index([deletedAt])
  @@map("projects")
}

model Phase {
  id        String    @id @default(cuid())
  name      String
  type      PhaseType
  order     Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  projectId  String
  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  activities Activity[]

  @@map("phases")
}

model Activity {
  id                  String            @id @default(cuid())
  code                String
  name                String
  description         String?
  order               Int
  durationDays        Int               @default(1)
  startDate           DateTime?
  endDate             DateTime?
  status              ActivityStatus    @default(PENDIENTE)
  progress            Int               @default(0)
  participationType   ParticipationType @default(SEIDOR)
  notes               String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  deletedAt           DateTime?

  // Baseline (valores originales planificados)
  baselineStartDate  DateTime?
  baselineEndDate    DateTime?
  baselineDuration   Int?
  isLocked           Boolean           @default(true)

  phaseId     String
  phase       Phase        @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  events      ProjectEvent[]
  timeEntries TimeEntry[]

  @@index([deletedAt])
  @@map("activities")
}

model ProjectAssignment {
  id                   String   @id @default(cuid())
  allocationPercentage Int      @default(100)
  hoursPerDay          Float    @default(8)
  startDate            DateTime?
  endDate              DateTime?
  active               Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@map("project_assignments")
}

model Holiday {
  id          String   @id @default(cuid())
  date        DateTime
  name        String
  year        Int
  recurring   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date])
  @@map("holidays")
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  sentEmail Boolean  @default(false)
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model ProjectEvent {
  id          String        @id @default(cuid())
  category    EventCategory
  type        String
  title       String
  description String?

  status      EventStatus   @default(ABIERTO)
  priority    Priority?

  startDate   DateTime      @default(now())
  endDate     DateTime?
  dueDate     DateTime?

  impactDays  Int?
  impactCost  Float?

  // Control de Cambios (para categoría CHANGE)
  changeRequestStatus  ChangeStatus?
  approvedBy           String?
  approvedAt           DateTime?
  approvedCost         Float?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  assignedToId  String?
  assignedTo    User?     @relation("EventAssignee", fields: [assignedToId], references: [id])

  reportedById  String
  reportedBy    User      @relation("EventReporter", fields: [reportedById], references: [id])

  activityId    String?
  activity      Activity? @relation(fields: [activityId], references: [id])

  @@index([deletedAt])
  @@map("project_events")
}

// Tipos de documentos del proyecto
enum DocumentType {
  PDD           // Process Design Document
  DSD           // Solution Design Document
  MANUAL        // Manual de Usuario
  ACTA          // Actas de reunión
  REQUERIMIENTO // Documento de requerimientos
  OTRO          // Otros documentos
}

// Documentos del proyecto (links a SharePoint)
model ProjectDocument {
  id          String       @id @default(cuid())
  name        String       // Nombre del documento
  type        DocumentType // Tipo de documento
  url         String       // URL de SharePoint
  description String?      // Descripción opcional
  version     String?      // Versión del documento (ej: "1.0", "2.1")

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  projectId   String
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  uploadedById String
  uploadedBy   User        @relation("DocumentUploader", fields: [uploadedById], references: [id])

  @@index([projectId])
  @@map("project_documents")
}

// Audit Log para historial de cambios
model AuditLog {
  id        String   @id @default(cuid())
  action    String   // CREATE, UPDATE, DELETE, STATUS_CHANGE
  entity    String   // Project, Activity, Event, User, Client
  entityId  String
  userId    String
  userName  String   // Cached for historical purposes
  oldData   String?  // JSON string of previous state
  newData   String?  // JSON string of new state
  metadata  String?  // Additional context (IP, user agent, etc)
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Registro de horas trabajadas por proyecto
model TimeEntry {
  id          String    @id @default(cuid())
  date        DateTime                        // Fecha del trabajo
  hours       Float                           // Horas (0.5 - 24)
  description String    @db.Text              // Qué se hizo
  task        String?                         // Nombre de tarea (opcional)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId      String
  user        User      @relation(fields: [userId], references: [id])

  activityId  String?                         // Opcional: vincular a actividad Gantt
  activity    Activity? @relation(fields: [activityId], references: [id])

  @@index([userId])
  @@index([projectId])
  @@index([date])
  @@map("time_entries")
}

// ==================== SOPORTE ====================

// Bolsa de horas de soporte
model SupportPool {
  id          String            @id @default(cuid())
  name        String
  description String?           @db.Text
  pep         String            @unique    // Código SAP/PEP para facturación
  status      SupportPoolStatus @default(ACTIVA)

  totalHours           Float              // Horas totales contratadas
  autoAcceptThreshold  Float?             // Umbral para auto-aceptar estimaciones

  startDate   DateTime?
  endDate     DateTime?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?
  deletedBy   String?

  clientId    String
  client      Client            @relation(fields: [clientId], references: [id])

  projectId   String?           // Proyecto opcional asociado
  project     Project?          @relation(fields: [projectId], references: [id])

  assignments SupportPoolAssignment[]
  flows       SupportFlow[]
  tickets     SupportTicket[]

  @@index([clientId])
  @@index([deletedAt])
  @@map("support_pools")
}

// Asignación de recursos a bolsa de soporte (N:N)
model SupportPoolAssignment {
  id        String   @id @default(cuid())
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  poolId    String
  pool      SupportPool @relation(fields: [poolId], references: [id], onDelete: Cascade)

  userId    String
  user      User        @relation(fields: [userId], references: [id])

  @@unique([poolId, userId])
  @@map("support_pool_assignments")
}

// Catálogo de flujos/procesos por bolsa
model SupportFlow {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  poolId      String
  pool        SupportPool     @relation(fields: [poolId], references: [id], onDelete: Cascade)

  tickets     SupportTicket[]

  @@index([poolId])
  @@map("support_flows")
}

// Ticket de soporte
model SupportTicket {
  id           String         @id @default(cuid())
  code         String         @unique    // TKT-2025-0001
  title        String
  description  String         @db.Text

  stage        TicketStage    @default(BACKLOG)
  type         TicketType     @default(INCIDENCIA)
  priority     TicketPriority @default(MEDIA)

  // URLs de adjuntos (SharePoint)
  screenshotUrl String?       // Screenshot o correo
  excelUrl      String?       // Excel con transacciones

  // Fechas
  incidentDate  DateTime?     // Cuando ocurrió el incidente
  reportedDate  DateTime      @default(now())
  startedAt     DateTime?     // Cuando empezó a atenderse
  resolvedAt    DateTime?     // Cuando se resolvió

  // Contacto
  reporterEmail String
  ccEmails      String?       @db.Text  // JSON array de emails

  // Estimación
  estimatedHours Float?
  autoAccepted   Boolean      @default(false)

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?
  deletedBy   String?

  poolId      String
  pool        SupportPool    @relation(fields: [poolId], references: [id], onDelete: Cascade)

  flowId      String?
  flow        SupportFlow?   @relation(fields: [flowId], references: [id])

  // Proyecto RPA relacionado (si aplica)
  projectId   String?
  project     Project?       @relation(fields: [projectId], references: [id])

  assignedToId String?
  assignedTo   User?         @relation("TicketAssignee", fields: [assignedToId], references: [id])

  createdById  String
  createdBy    User          @relation("TicketCreator", fields: [createdById], references: [id])

  comments     TicketComment[]
  attachments  TicketAttachment[]
  timeEntries  TicketTimeEntry[]
  history      TicketHistory[]

  @@index([poolId])
  @@index([stage])
  @@index([deletedAt])
  @@map("support_tickets")
}

// Comentarios en tickets
model TicketComment {
  id         String   @id @default(cuid())
  content    String   @db.Text
  isInternal Boolean  @default(false)  // Comentario interno (no visible al cliente)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  ticketId   String
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId   String
  author     User          @relation(fields: [authorId], references: [id])

  @@index([ticketId])
  @@map("ticket_comments")
}

// Adjuntos adicionales en tickets
model TicketAttachment {
  id          String   @id @default(cuid())
  name        String
  url         String   // URL de SharePoint
  description String?
  createdAt   DateTime @default(now())

  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  uploadedById String
  uploadedBy   User         @relation(fields: [uploadedById], references: [id])

  @@index([ticketId])
  @@map("ticket_attachments")
}

// Registro de horas por ticket
model TicketTimeEntry {
  id          String   @id @default(cuid())
  date        DateTime
  hours       Float
  description String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId      String
  user        User         @relation(fields: [userId], references: [id])

  @@index([ticketId])
  @@index([userId])
  @@index([date])
  @@map("ticket_time_entries")
}

// Historial de cambios del ticket
model TicketHistory {
  id         String   @id @default(cuid())
  field      String   // stage, priority, assignedTo, etc.
  oldValue   String?
  newValue   String?
  createdAt  DateTime @default(now())

  ticketId   String
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId     String
  user       User          @relation(fields: [userId], references: [id])

  @@index([ticketId])
  @@map("ticket_history")
}
